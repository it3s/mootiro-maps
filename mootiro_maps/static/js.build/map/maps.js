(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=Object.prototype.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},r=Array.prototype.indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["require","googlemaps","underscore","./core","./collections","./features","./layers","./geometries","./controls","./maptypes","./providers"],function(t){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;return v=t("googlemaps"),g=t("underscore"),h=t("./core"),c=t("./collections"),p=t("./features"),m=t("./layers"),d=t("./geometries"),t("./controls"),t("./maptypes"),t("./providers"),window.komoo==null&&(window.komoo={}),(y=window.komoo).event==null&&(y.event=v.event),u=function(t){function i(t){var n;this.options=t!=null?t:{},this.addFeature=e(this.addFeature,this),i.__super__.constructor.call(this),this.element=(n=this.options.element)!=null?n:document.getElementById(this.options.elementId),this.features=c.makeFeatureCollectionPlus({map:this}),this.components={},this.setProjectId(this.options.projectId),this.initGoogleMap(this.options.googleMapOptions),this.initFeatureTypes(),this.initLayers(),this.handleEvents(),this.addComponents(["map/controls::Location",["map/controls::LayersBox","panel",{el:"#map-panel-layers"}]])}return n(i,t),i.prototype.featureTypesUrl="/map_info/feature_types/",i.prototype.layersUrl="/map_info/layers/",i.prototype.googleMapDefaultOptions={zoom:12,center:new v.LatLng(-23.55,-46.65),disableDefaultUI:!1,streetViewControl:!0,scaleControl:!0,panControlOptions:{position:v.ControlPosition.RIGHT_TOP},zoomControlOptions:{position:v.ControlPosition.RIGHT_TOP},scaleControlOptions:{position:v.ControlPosition.RIGHT_BOTTOM,style:v.ScaleControlStyle.DEFAULT},mapTypeControlOptions:{mapTypeIds:[v.MapTypeId.ROADMAP,v.MapTypeId.HYBRID]},mapTypeId:v.MapTypeId.HYBRID},i.prototype.addControl=function(e,t){return this.googleMap.controls[e].push(t)},i.prototype.loadGeoJsonFromOptions=function(){var e,t;if(this.options.geojson)return t=this.loadGeoJSON(this.options.geojson,this.options.zoom==null),e=t.getBounds(),e!=null&&this.fitBounds(e),t!=null&&t.setMap(this,{geometry:!0,icon:!0}),this.publish("set_zoom",this.options.zoom)},i.prototype.initGoogleMap=function(e){return e==null&&(e=this.googleMapDefaultOptions),this.googleMap=new v.Map(this.element,e),this.handleGoogleMapEvents(),$(this.element).trigger("initialized",this)},i.prototype.handleGoogleMapEvents=function(){var e,t=this;return e=["click","idle","maptypeid_changed","zoom_changed"],e.forEach(function(e){return komoo.event.addListener(t.googleMap,e,function(n){return t.publish(e,n)})})},i.prototype.initFeatureTypes=function(){var e,t=this;return this.featureTypes==null&&(this.featureTypes={}),this.options.featureTypes!=null?((e=this.options.featureTypes)!=null&&e.forEach(function(e){return t.featureTypes[e.type]=e}),this.loadGeoJsonFromOptions()):$.ajax({url:this.featureTypesUrl,dataType:"json",success:function(e){return e.forEach(function(e){return t.featureTypes[e.type]=e}),t.loadGeoJsonFromOptions()}})},i.prototype.initLayers=function(){return this.layers==null&&(this.layers=new m.Layers),this.options.layers!=null?this.loadLayersFromOptions(this.options):this.loadRemoteLayers(this.layersUrl)},i.prototype.loadLayer=function(e){var t;return t=new m.Layer(g.extend({collection:this.getFeatures(),map:this},e)),this.layers.addLayer(t),this.publish("layer_loaded",t)},i.prototype.loadLayersFromOptions=function(e){var t=this;return e.layers.forEach(function(e){return t.loadLayer(e)})},i.prototype.loadRemoteLayers=function(e){var t=this;return $.ajax({url:e,dataType:"json",success:function(e){return e.forEach(function(e){return t.loadLayer(e)})}})},i.prototype.getLayers=function(){return this.layers},i.prototype.getLayer=function(e){return this.layers.getLayer(e)},i.prototype.showLayer=function(e){return g.isString(e)&&(e=this.getLayer(e)),e.show(),this.publish("show_layer",e)},i.prototype.hideLayer=function(e){return g.isString(e)&&(e=this.getLayer(e)),e.hide(),this.publish("hide_layer",e)},i.prototype.handleEvents=function(){var e=this;return this.subscribe("features_loaded",function(t){return komoo.event.trigger(e,"features_loaded",t)}),this.subscribe("close_clicked",function(){return komoo.event.trigger(e,"close_click")}),this.subscribe("drawing_started",function(t){return komoo.event.trigger(e,"drawing_started",t)}),this.subscribe("drawing_finished",function(t,n){komoo.event.trigger(e,"drawing_finished",t,n);if(n===!1)return e.revertFeature(t);if(t.getProperty("id")==null)return e.addFeature(t)}),this.subscribe("set_location",function(t){var n;return t=t.split(","),n=new v.LatLng(t[0],t[1]),e.googleMap.setCenter(n)}),this.subscribe("set_zoom",function(t){return e.setZoom(t)}),this.subscribe("idle",function(t){return e.getFeatures().setVisible(!0)})},i.prototype.addComponent=function(e,t,n){var r,i=this;return t==null&&(t="generic"),n==null&&(n={}),r=g.isString(e)?this.start(e,n.el,n):this.start(e),this.data.when(r).done(function(){var e,n,r,s,o;o=[];for(r=0,s=arguments.length;r<s;r++)e=arguments[r],e.setMap(i),(n=i.components)[t]==null&&(n[t]=[]),i.components[t].push(e),o.push(typeof e.enable=="function"?e.enable():void 0);return o})},i.prototype.addComponents=function(e){var t,n,r,i,s,o,u,a=this;n=[];for(i=0,s=e.length;i<s;i++)t=e[i],g.isString(t)&&(t=[t]),r=(o=t[2])!=null?o:{},r.type==null&&(r.type=(u=t[1])!=null?u:"generic"),n.push({component:t[0],el:r.el,opts:r});return this.data.when(this.start(n)).done(function(){var e,t,n,r,i,s;s=[];for(n=0,r=arguments.length;n<r;n++)e=arguments[n],typeof e.setMap=="function"&&e.setMap(a),(t=a.components)[i=e.type]==null&&(t[i]=[]),a.components[e.type].push(e),s.push(typeof e.enable=="function"?e.enable():void 0);return s})},i.prototype.enableComponents=function(e){var t,n=this;return(t=this.components[e])!=null?t.forEach(function(e){return typeof e.enable=="function"?e.enable():void 0}):void 0},i.prototype.disableComponents=function(e){var t,n=this;return(t=this.components[e])!=null?t.forEach(function(e){return typeof e.disable=="function"?e.disable():void 0}):void 0},i.prototype.getComponentsStatus=function(e){var t,n,i=this;return t=[],(n=this.components[e])!=null&&n.forEach(function(e){if(e.enabled===!0)return t.push("enabled")}),r.call(t,"enabled")>=0?"enabled":"disabled"},i.prototype.clear=function(){return this.features.removeAllFromMap(),this.features.clear()},i.prototype.refresh=function(){return v.event.trigger(this.googleMap,"resize")},i.prototype.saveLocation=function(e,t){return e==null&&(e=this.googleMap.getCenter()),t==null&&(t=this.getZoom()),this.publish("save_location",e,t)},i.prototype.goToSavedLocation=function(){return this.publish("goto_saved_location"),!0},i.prototype.goToUserLocation=function(){return this.publish("goto_user_location")},i.prototype.handleFeatureEvents=function(e){var t,n=this;return t=["mouseover","mouseout","mousemove","click","dblclick","rightclick","highlight_changed"],t.forEach(function(t){return komoo.event.addListener(e,t,function(r){return n.publish("feature_"+t,r,e)})})},i.prototype.goTo=function(e,t){return t==null&&(t=!0),this.publish("goto",e,t)},i.prototype.panTo=function(e,t){return t==null&&(t=!1),this.goTo(e,t)},i.prototype.makeFeature=function(e,t){var n;return t==null&&(t=!0),n=p.makeFeature(e,this.featureTypes),t&&this.addFeature(n),this.publish("feature_created",n),n},i.prototype.addFeature=function(e){return this.handleFeatureEvents(e),this.features.push(e),this.publish("feature_added",e)},i.prototype.revertFeature=function(e){if(e.getProperty("id")==null)return e.setMap(null)},i.prototype.getFeatures=function(){return this.features},i.prototype.showFeatures=function(e){return e==null&&(e=this.features),e.show()},i.prototype.hideFeatures=function(e){return e==null&&(e=this.features),e.hide()},i.prototype.centerFeature=function(e,t){var n;return n=e instanceof p.Feature?e:this.features.getById(e,t),this.panTo(n!=null?n.getCenter():void 0,!1)},i.prototype.loadGeoJson=function(e,t,n,r){var i,s,o=this;return t==null&&(t=!1),n==null&&(n=!0),r==null&&(r=!1),i=c.makeFeatureCollection({map:this}),(e!=null?e.type:void 0)==null||!e.type==="FeatureCollection"?i:((s=e.features)!=null&&s.forEach(function(e){var t;return t=o.features.getById(e.properties.type,e.properties.id),t==null&&(t=o.makeFeature(e,n)),i.push(t),t.setVisible(!0)}),t&&i.getBounds()!=null&&this.fitBounds(),r||this.publish("features_loaded",i),i)},i.prototype.loadGeoJSON=function(e,t,n,r){return this.loadGeoJson(e,t,n,r)},i.prototype.getGeoJson=function(e){var t;return e==null&&(e={}),e.newOnly==null&&(e.newOnly=!1),e.currentOnly==null&&(e.currentOnly=!1),e.geometryCollection==null&&(e.geometryCollection=!1),t=e.newOnly?this.newFeatures:e.currentOnly?c.makeFeatureCollection({map:this.map,features:[this.currentFeature]}):this.features,t.getGeoJson({geometryCollection:e.geometryCollection})},i.prototype.getGeoJSON=function(e){return this.getGeoJson(e)},i.prototype.drawNewFeature=function(e,t){var n;return n=this.makeFeature({type:"Feature",geometry:{type:e},properties:{name:"New "+t,type:t}}),this.publish("draw_feature",e,n)},i.prototype.editFeature=function(e,t){return e==null&&(e=this.features.getAt(0)),t!=null&&e.getGeometryType()===d.types.EMPTY?(e.setGeometry(d.makeGeometry({geometry:{type:t}})),this.publish("draw_feature",t,e)):this.publish("edit_feature",e)},i.prototype.setMode=function(e){return this.mode=e,this.publish("mode_changed",this.mode)},i.prototype.selectCenter=function(e,t){return this.selectPerimeter(e,t)},i.prototype.selectPerimeter=function(e,t){return this.publish("select_perimeter",e,t)},i.prototype.highlightFeature=function(){return this.centerFeature.apply(this,arguments),this.features.highlightFeature.apply(this.features,arguments)},i.prototype.getBounds=function(){return this.googleMap.getBounds()},i.prototype.getZoom=function(){return this.googleMap.getZoom()},i.prototype.setZoom=function(e){if(e!=null)return this.googleMap.setZoom(e)},i.prototype.fitBounds=function(e){return e==null&&(e=this.features.getBounds()),this.googleMap.fitBounds(e)},i.prototype.getMapTypeId=function(){return this.googleMap.getMapTypeId()},i.prototype.getProjectId=function(){return this.projectId},i.prototype.setProjectId=function(e){this.projectId=e},i}(h.Mediator),l=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::AutosaveMapType",["map/maptypes::CleanMapType","mapType"],["map/controls::DrawingManager","drawing"],"map/controls::SearchBox"])}return n(t,e),t.prototype.type="editor",t}(u),o=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::AutosaveMapType","map/maptypes::CleanMapType","map/controls::SaveLocation","map/controls::StreetView","map/controls::DrawingManager","map/controls::DrawingControl","map/controls::GeometrySelector","map/controls::PerimeterSelector","map/controls::SearchBox"])}return n(t,e),t.prototype.type="view",t}(u),a=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.type="preview",t.prototype.googleMapDefaultOptions={zoom:12,center:new v.LatLng(-23.55,-46.65),disableDefaultUI:!0,streetViewControl:!1,scaleControl:!0,scaleControlOptions:{position:v.ControlPosition.RIGHT_BOTTOM,style:v.ScaleControlStyle.DEFAULT},mapTypeId:v.MapTypeId.HYBRID},t}(u),f=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::AutosaveMapType",["map/maptypes::CleanMapType","mapType"],"map/controls::AutosaveLocation","map/controls::StreetView",["map/controls::Tooltip","tooltip"],["map/controls::InfoWindow","infoWindow"],"map/controls::LicenseBox","map/controls::SearchBox"])}return n(t,e),t.prototype.type="view",t}(u),s=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::LoadingBox",["map/providers::ZoomFilteredFeatureProvider","provider"],["map/controls::CommunityClusterer","clusterer",{map:this}],"map/controls::FeatureZoomFilter","map/controls::LayersFilter"])}return n(t,e),t.prototype.type="view",t}(f),i=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::DrawingManager","map/controls::DrawingControl","map/controls::GeometrySelector","map/controls::PerimeterSelector"]),this.goToSavedLocation()||this.goToUserLocation()}return n(t,e),t.prototype.type="editor",t}(s),window.komoo.maps={Map:u,Preview:a,AjaxMap:s,makeMap:function(e){var t,n;e==null&&(e={}),t=(n=e.type)!=null?n:"map";if(t==="main")return new i(e);if(t==="editor")return new o(e);if(t==="view")return new s(e);if(t==="static")return new f(e);if(t==="preview"||t==="tooltip")return new a(e);if(t==="userEditor")return new l(e)}},window.komoo.maps})}).call(this);